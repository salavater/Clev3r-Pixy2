import "Pixy2"

Program.Delay(100)

#region functions for printing

Function printPixel2x2(in number x, in number y, in number type)
  
  If type = 1 Then
    LCD.Pixel(1,x,y+1)
  EndIf
  If type = 2 Then
    LCD.Pixel(1,x,y+1)
    LCD.Pixel(1,x+1,y)
  EndIf
  If type = 3 Then
    LCD.Pixel(1,x,y)
    LCD.Pixel(1,x+1,y)
    LCD.Pixel(1,x+1,y+1)
  EndIf
  If type = 4 Then
    LCD.Pixel(1,x,y)
    LCD.Pixel(1,x+1,y)
    LCD.Pixel(1,x,y+1)
    LCD.Pixel(1,x+1,y+1)
  EndIf
  
EndFunction

Function lineForFile(in number type, in string lineIn, out string lineOut)
  
  If type = 0 Then
    lineOut = lineIn + " "
  EndIf
  If type = 1 Then
    lineOut = lineIn + "."
  EndIf
  If type = 2 Then
    lineOut = lineIn + ":"
  EndIf
  If type = 3 Then
    lineOut = lineIn + "!"
  EndIf
  If type = 4 Then
    lineOut = lineIn + "@"
  EndIf
  
EndFunction

#endRegion

#region print resolution
Pixy2.getRGB(2,84,2,2,0,r,g,b)
Pixy2.getResolution(2,84,weight,height)

LCD.Clear()
LCD.Text(1,40,20,1,"Resolution:")
LCD.Text(1,40,30,1,"Weight: " + weight)
LCD.Text(1,40,40,1,"Height: " + height)
LCD.Text(1,20,60,1,"Resolution must ")
LCD.Text(1,40,75,1,"be 315/208")
LCD.Text(1,20,95,1,"Press any button")

Buttons.Flush()
Buttons.Wait()
#endRegion

'start program'
@volume = 20

Pixy2.setLamp(2,84,1,1)

kx = 2
ky = 2
pic[0] = 0
arrayR[0] = 0
arrayG[0] = 0
arrayB[0] = 0

xResolution = 62'62
yResolution = 41'41

xShift = 32
yShift = 23

#region taking photo

maxGray = 0
minGray = 1

LCD.Clear()
LCD.Rect(1,xShift-2, yShift-2, xResolution*kx+4, yResolution*ky+4)

For yStep = 0 To yResolution
  For xStep = 0 To xResolution
    
    x = 2 + xStep * 5
    y = 2 + yStep * 5
    
    Pixy2.getRGB(2,84,x,y,0,r,g,b)
    
    gray = (r+g+b)/765 ' value 0-1
    pic[y*xResolution + x] = gray
    arrayR[y*xResolution + x] = r
    arrayG[y*xResolution + x] = g
    arrayB[y*xResolution + x] = b
    
    If gray > maxGray Then
      maxGray = gray
    EndIf
    If gray < minGray Then
      minGray = gray
    EndIf
    
    type = 4 -  Math.Round((gray-minGray)/(maxGray - minGray) * 5 - 0.5)
    printPixel2x2(xShift + xStep*kx, yShift + yStep*ky, type)
    
    Program.Delay(30)
    
  EndFor
  Speaker.Tone(@volume,1200,100)
EndFor

Program.Delay(150)
Speaker.Tone(@volume,1200,100)

Buttons.Flush()
Buttons.Wait()
#endRegion

#region reprint photo

LCD.Clear()
LCD.Rect(1,xShift-2, yShift-2, xResolution*kx+4, yResolution*ky+4)

For yStep = 0 To yResolution
  For xStep = 0 To xResolution
    
    x = 2 + xStep * 5
    y = 2 + yStep * 5
    
    gray = pic[y*xResolution + x] ' value 0-1
    
    type = 4 -  Math.Round((gray-minGray)/(maxGray - minGray) * 5 - 0.5)
    printPixel2x2(xShift + xStep*kx, yShift + yStep*ky, type)
    
    'Program.Delay(10)
  EndFor
EndFor

Program.Delay(150)
Speaker.Tone(@volume,1200,100)
#endRegion

#region save photo to txt file in char and RGB file

char_f = EV3File.OpenWrite("char_picture.txt")
rgb_f = EV3File.OpenWrite("rgb.txt")

EV3File.WriteLine(rgb_f,xResolution + " " + yResolution)

For yStep = 0 To yResolution
  char_line = ""
  rgb_line = ""
  For xStep = 0 To xResolution
    
    x = 2 + xStep * 5
    y = 2 + yStep * 5
    
    gray = pic[y*xResolution+x] ' value 0-1
    
    rgb_line = rgb_line + EV3File.ConvertToNumber(arrayR[y*xResolution+x]) + " " + EV3File.ConvertToNumber(arrayG[y*xResolution+x] )+ " " + EV3File.ConvertToNumber(arrayB[y*xResolution+x]) + " "
    
    type = 4 -  Math.Round((gray-minGray)/(maxGray - minGray) * 5 - 0.5)
    lineForFile(type, char_line, char_line)
    
  EndFor
  EV3File.WriteLine(char_f,char_line)
  EV3File.WriteLine(rgb_f,rgb_line)
EndFor

EV3File.Close(char_f)
EV3File.Close(rgb_f)

Program.Delay(150)
Speaker.Tone(@volume,1200,100)

Buttons.Flush()
Buttons.Wait()

#endRegion
